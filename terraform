// main.tf

// Configuração do provider - AWS
// Define a região da AWS a ser utilizada para a implantação dos recursos
provider "aws" {
  region = var.region
}

// Configurações do Terraform
// Especifica o provider necessário e sua versão
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
  required_version = ">= 1.0.0"

  // Backend S3 - Armazenamento do state no S3
  backend "s3" {
    bucket         = var.s3_bucket
    key            = var.s3_key
    region         = var.region
    dynamodb_table = var.dynamodb_table
    encrypt        = true
  }
}

// Recurso de Security Group
// Cria um Security Group para o AWS WorkSpaces com as regras de entrada e saída especificadas
resource "aws_security_group" "workspaces_sg" {
  name        = var.sg_name
  description = "SG para AWS WorkSpaces"
  vpc_id      = var.vpc_id

  // Tags associadas ao Security Group
  tags = {
    POC        = var.tag_poc
    Workspace  = var.tag_workspace
    Repositorio = var.tag_repositorio
  }

  // Regras de entrada dinâmicas
  dynamic "ingress" {
    for_each = var.rules_ingress
    content {
      from_port   = ingress.value.port
      to_port     = ingress.value.port
      protocol    = ingress.value.protocol
      cidr_blocks = ingress.value.source_ips
      description = ingress.value.description
    }
  }

  // Regras de saída dinâmicas
  dynamic "egress" {
    for_each = var.rules_egress
    content {
      from_port   = egress.value.port
      to_port     = egress.value.port
      protocol    = egress.value.protocol
      cidr_blocks = egress.value.destination_ips
      description = egress.value.description
    }
  }
}

// data.tf

// Obtém o ID da conta AWS e a região configurada
data "aws_caller_identity" "current" {}

data "aws_region" "current" {}

output "account_id" {
  description = "ID da conta AWS atual"
  value       = data.aws_caller_identity.current.account_id
}

output "current_region" {
  description = "Região configurada"
  value       = data.aws_region.current.name
}


// outputs.tf

// Output do ID do Security Group para referência e uso em outros módulos ou recursos
output "security_group_id" {
  description = "O ID do Security Group criado"
  value       = aws_security_group.workspaces_sg.id
}


// variables.tf

// Define a região da AWS a ser utilizada
variable "region" {
  description = "Região da AWS"
  type        = string
  default     = "us-east-1"
}

// Nome do Security Group
variable "sg_name" {
  description = "Nome do Security Group"
  type        = string
  default     = "workspaces-sg"
}

// ID da VPC onde o Security Group será criado
variable "vpc_id" {
  description = "ID da VPC"
  type        = string
}

// Tags do projeto
variable "tag_poc" {
  description = "Tag POC"
  type        = string
  default     = "AWS"
}

variable "tag_workspace" {
  description = "Tag Workspace"
  type        = string
  default     = "Agências"
}

variable "tag_repositorio" {
  description = "Tag Repositório"
  type        = string
  default     = "https://xxxx.com.br"
}

// Regras de entrada
variable "rules_ingress" {
  description = "Regras de entrada com porta, protocolo, IPs de origem e descrição"
  type        = list(object({
    port       = number
    protocol   = string
    source_ips = list(string)
    description = string
  }))
  default = [
    { port = 3389, protocol = "tcp", source_ips = ["192.168.0.1/32"], description = "RDP Access" },
    { port = 8443, protocol = "tcp", source_ips = ["192.168.0.2/32"], description = "HTTPS Access" }
  ]
}

// Regras de saída
variable "rules_egress" {
  description = "Regras de saída com porta, protocolo, IPs de destino e descrição"
  type        = list(object({
    port          = number
    protocol      = string
    destination_ips = list(string)
    description   = string
  }))
  default = [
    { port = 80, protocol = "tcp", destination_ips = ["0.0.0.0/0"], description = "HTTP Outbound" },
    { port = 443, protocol = "tcp", destination_ips = ["0.0.0.0/0"], description = "HTTPS Outbound" }
  ]
}

// Variáveis para o backend S3
variable "s3_bucket" {
  description = "Nome do bucket S3 onde o state será armazenado"
  type        = string
}

variable "s3_key" {
  description = "Caminho do arquivo state no S3"
  type        = string
}

variable "dynamodb_table" {
  description = "Tabela DynamoDB para controle de locking do state"
  type        = string
}


// terraform.tfvars

// Exemplo de como definir valores para as variáveis
region   = "us-east-1"
sg_name  = "workspaces-sg"
vpc_id   = "vpc-12345678"
s3_bucket = "meu-bucket-terraform-state"
s3_key    = "terraform/state.tfstate"
dynamodb_table = "terraform-lock"
tag_poc = "AWS"
tag_workspace = "Agências"
tag_repositorio = "https://xxxx.com.br"
rules_ingress = [
  { port = 3389, protocol = "tcp", source_ips = ["192.168.0.1/32"], description = "RDP Access" },
  { port = 8443, protocol = "tcp", source_ips = ["192.168.0.2/32"], description = "HTTPS Access" }
]
rules_egress = [
  { port = 80, protocol = "tcp", destination_ips = ["0.0.0.0/0"], description = "HTTP Outbound" },
  { port = 443, protocol = "tcp", destination_ips = ["0.0.0.0/0"], description = "HTTPS Outbound" }
]
